{% extends 'base.html' %}
{% load i18n admin_urls %}
{% block title %}{{map.name}} {% endblock %}
{% block style %}
{{ block.super }}
<link rel="stylesheet" href="//unpkg.com/leaflet@1.4.0/dist/leaflet.css"/>
<link rel="stylesheet" href="//unpkg.com/leaflet.markercluster@1.0.5/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="//unpkg.com/leaflet.markercluster@1.0.5/dist/MarkerCluster.Default.css"/>
<link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
<link rel="stylesheet" href="/static/css/leaflet.wmslegend.css"/>
<link rel="stylesheet" href="/static/css/maps.css"/>
{% endblock %}
{% block script %}
{{ block.super }}
<script src="//maps.googleapis.com/maps/api/js?key={{api_key}}" async defer></script>
<script src="//unpkg.com/leaflet@1.4.0/dist/leaflet.js"></script>
<script src="//unpkg.com/leaflet.gridlayer.googlemutant@latest/Leaflet.GoogleMutant.js"></script>
<script src="//unpkg.com/leaflet.markercluster@1.0.5/dist/leaflet.markercluster.js"></script>
<script src="//unpkg.com/esri-leaflet@2.1.1/dist/esri-leaflet.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
<script src="/static/js/leaflet.wmslegend.js"></script>
<script src="/static/js/betterwms.js"></script>
<script src="/static/js/xml2json.js"></script>
<script src="/static/js/maps.js"></script>
<script src="/static/js/inventory.js"></script>
<script>

var inventory = new Inventory()
var legend;

function getCookie(cookie) {
	const cookies = decodeURIComponent(document.cookie).split(';')
		.map(token => token.trim())
		.filter(token => token.startsWith(cookie));
	return cookies.length==1? cookies[0].substring(cookie.length+1): "";
}

/***
 * returns array of promises (one for every group) that resolve when layers in the group have been loaded
 */
async function addAllOverlays(groups, map, list) {
	let id = 0;
	return Object.keys(groups).map(name => {
		const layers = groups[name]
		const groupId = `group${id++}`;
		let item = `<a class="list-group-item list-group-item-secondary" data-toggle="collapse" href="#${groupId}" aria-expanded="true" aria-controls="${groupId}">
		<i class="fas pr-3 fa-layer-group"></i><strong>${name}</strong></a>
		<div class="collapse show" id="${groupId}"></div>`;
		list.append(item);

		// Allow user to sort layers in group list
		$(`#${groupId}`).sortable({
			update: function(event,ui) {
				// copy text of divs with a data-toggle attribute (displayName of layers) to array
				const keys = $(this).find('div[data-toggle]').toArray().map(e => e.innerText);
				console.debug(keys);
				$.post('reorder/',JSON.stringify(keys)).then(()=> {
					sortOverlays(overlayLayers,keys);
				});
			}
		});
		return addOverlays(map, $(`#${groupId}`), layers)
	});
}

function getSelectedProperty() {
	const prop = $("#property option:selected").text()
	return prop.startsWith('Choose') ? undefined : prop 
}

function propertyChanged() {
	inventory.attribute = getSelectedProperty()
	showLegend(theMap)
	inventory.redraw(theMap)
}

/***
 * call getFeatureInfo on all WMS layers on the map and return contents of html table for popup
 */
async function getFeatureInfo(map, evt) {
	const layers = map._layers
	const wmsKeys = Object.keys(layers).filter(key => {
		const layer = layers[key]
		return layer.wmsParams && layer.wmsParams.clickable
	})
	const promises = wmsKeys.map(key => {		
		const layer = layers[key];
	    const params = layer.getFeatureInfoParams(evt.latlng);
	    return $.get(layer._url,params).then(response => {
	    	return layer.formatFeatureInfoResponse(response);
		})
	})
	const featureInfo = await Promise.all(promises)
	return featureInfo.filter(a => a.length > 0)
}

function showLegend(map) {
	if (legend)
		legend.remove()
	legend = L.control({position: "bottomright"})
	legend.onAdd = function(map) {
		const div = L.DomUtil.create("div", "legend");
		div.innerHTML = inventory.getLegendContent()
		return div;
	}
	legend.addTo(map)
}

$(function() {

	// initialize the map
	const options = {{options|safe}};
	const map = initMap('map',options,{{map.id}});
	
	// set the extent of the map
	const extent = {{extent}};
	if (extent.length === 4) {
		const bounds = L.latLngBounds([extent[1],extent[0]],[extent[3],extent[2]]);
		map.fitBounds(bounds);
	}

	// load overlays
	const list = $("#list");
	overlayLayers = [];
	$.getJSON('/map/{{map.pk}}/config/').then(groups => {
		addAllOverlays(groups, map, list).then(() => {
			map.on('click', evt => {
				// query all visible wms layers
				getFeatureInfo(map, evt).then(info => {
					if (info.length > 0) {
				    	L.popup({ maxWidth: 800})
					    .setLatLng(evt.latlng)
					    .setContent('<table class="table table-sm">' + info.join('\n') + '</table>')
					    .openOn(map)  	
					}
				})
			})
		})
	})	
	// Load the inventory data
	inventory.loadData('/static/inventory.json').then(data => {

		// load style for inventory data
		inventory.loadStyles('/static/styles.json').then(styles => {
			// add select control to ui
			let text = '<li class="list-group-item list-group-item-secondary">Inventory Data</li><select id="property" class="custom-select" onchange="propertyChanged()"><option selected>Choose...</option>';
			let index = 1;
			for (const cls in styles.classes) {
				text += `<option value="${index}">${cls}</option>`;
				index++;
			}
			text += '</select>';
			$("#inventory").html(text);

			// create layer and add to map
			inventory.createLayer(data).addTo(map)
		})
		
	})
});

</script>
<style>
</style>
{% endblock %}
{% block header %}
<nav class="navbar navbar-dark unibar">
	<li class="nav nav-brand nav-item dropdown">
        <a class="nav-link dropdown-toggle unibar" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          {{object.name}}
        </a>
        <div class="dropdown-menu unibar" aria-labelledby="navbarDropdown">
          <a class="dropdown-item unibar" href="/map?cluster=1">Cluster 1 - Wag Himra</a>
          <a class="dropdown-item unibar" href="/map?cluster=2">Cluster 2 - Afar</a>
          <a class="dropdown-item unibar" href="/map?cluster=3">Cluster 3 - Siti</a>
          <a class="dropdown-item unibar" href="/map?cluster=4">Cluster 4 - Liben</a>
          <a class="dropdown-item unibar" href="/map?cluster=5">Cluster 5 - Bale</a>
          <a class="dropdown-item unibar" href="/map?cluster=6">Cluster 6 - Borena</a>
          <a class="dropdown-item unibar" href="/map?cluster=7">Cluster 7 - Wolayta</a>
          <a class="dropdown-item unibar" href="/map?cluster=8">Cluster 8 - South Omo</a>
        </div>
      </li>
   <li class="nav justify-content-end">
    	<a href="//www.unicef.org/ethiopia"><img class="logo" src="/static/unicef.png"></img></a>
    	<a href="https://eeas.europa.eu/delegations/ethiopia_en"><img class="logo" src="/static/eulogo.jpg"></img></a>
    	<a href="http://www.acaciawater.com"><img class="logo ml-3" src="/static/default-logo.png"></img></a>
   </li>
</nav>
{% endblock %}
{% block content %}
<div class="row row-fluid flex-grow-1 mx-0 px-0">
	<div id="map" class="col-sm-10"></div>
	{% block list %}
	<div id="listwrapper" class="col-sm-2">
		<div id="list" class="list-group scroll"></div>
		<div id="inventory" class="list-group scroll mt-3"></div>
	</div>
	{% endblock list %}
</div>
{% endblock %}